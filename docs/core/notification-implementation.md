# ç«™å†…ä¿¡ç³»ç»Ÿå®ç°åŸç†è¯¦è§£

## ğŸ“Š ç«™å†…ä¿¡ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å®¢æˆ·ç«¯ (æµè§ˆå™¨/App)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  FastAPI åº”ç”¨å±‚                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  è®¤è¯ä¸­é—´ä»¶   â”‚  â”‚   API è·¯ç”±    â”‚  â”‚   æƒé™éªŒè¯    â”‚ â”‚
â”‚  â”‚  (JWT Token) â”‚  â”‚  (REST API)  â”‚  â”‚  (ä¾èµ–æ³¨å…¥)   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ä¸šåŠ¡é€»è¾‘å±‚ (Services)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   AuthService        â”‚  â”‚ NotificationService  â”‚   â”‚
â”‚  â”‚  - register          â”‚  â”‚  - åˆ›å»ºç«™å†…ä¿¡         â”‚   â”‚
â”‚  â”‚  - login             â”‚  â”‚  - å‘é€ç»™ç”¨æˆ·         â”‚   â”‚
â”‚  â”‚  - verify_token      â”‚  â”‚  - æŸ¥è¯¢åˆ—è¡¨           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  - æ ‡è®°å·²è¯»           â”‚   â”‚
â”‚                            â”‚  - åˆ é™¤ç«™å†…ä¿¡         â”‚   â”‚
â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ•°æ®è®¿é—®å±‚ (ORM - SQLAlchemy)          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ User Model   â”‚  â”‚ Notification â”‚  â”‚ Notification â”‚ â”‚
â”‚  â”‚              â”‚  â”‚   Model      â”‚  â”‚   Record     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   PostgreSQL æ•°æ®åº“                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ æ ¸å¿ƒè®¾è®¡æ€æƒ³ï¼šå†…å®¹ä¸è®°å½•åˆ†ç¦»

ç«™å†…ä¿¡ç³»ç»Ÿæœ€é‡è¦çš„è®¾è®¡æ˜¯**å†…å®¹ä¸è®°å½•åˆ†ç¦»**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  notifications     â”‚         â”‚  notification_records    â”‚
â”‚  (ç«™å†…ä¿¡å†…å®¹)       â”‚         â”‚  (ç”¨æˆ·æ¥æ”¶è®°å½•)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id: msg_001        â”‚â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”‚ id: record_001           â”‚
â”‚ title: "ç³»ç»Ÿå…¬å‘Š"  â”‚    â”‚    â”‚ notification_id: msg_001 â”‚
â”‚ content: "..."     â”‚    â”œâ”€â”€â”€â”€â”‚ user_id: user_A          â”‚
â”‚                    â”‚    â”‚    â”‚ is_read: false           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â”œâ”€â”€â”€â”€â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚    â”‚ id: record_002           â”‚
                          â””â”€â”€â”€â”€â”‚ notification_id: msg_001 â”‚
                               â”‚ user_id: user_B          â”‚
                               â”‚ is_read: true            â”‚
                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸ºä»€ä¹ˆè¦è¿™æ ·è®¾è®¡ï¼Ÿ**

1. **é¿å…æ•°æ®å†—ä½™**ï¼š1000ä¸ªç”¨æˆ·æ”¶åˆ°åŒä¸€æ¡å…¬å‘Šï¼Œä¸éœ€è¦å­˜å‚¨1000ä»½ç›¸åŒçš„å†…å®¹
2. **ä¾¿äºä¿®æ”¹**ï¼šä¿®æ”¹å…¬å‘Šå†…å®¹æ—¶ï¼Œåªéœ€è¦æ›´æ–°ä¸€æ¬¡
3. **èŠ‚çœå­˜å‚¨ç©ºé—´**ï¼šå†…å®¹åªå­˜ä¸€ä»½ï¼Œç”¨æˆ·åªå­˜è®°å½•

## ğŸ“¦ æ•°æ®æ¨¡å‹å®ç°

ç«™å†…ä¿¡ç³»ç»Ÿç”±ä¸‰ä¸ªæ ¸å¿ƒæ¨¡å‹ç»„æˆï¼š

### 1. ç”¨æˆ·è¡¨ (users)

```python
class User(Base):
    """ç”¨æˆ·è¡¨"""
    __tablename__ = "users"

    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    username = Column(String(50), unique=True, nullable=False)
    email = Column(String(100), unique=True, nullable=False)
    password_hash = Column(String(255), nullable=False)
    status = Column(SQLEnum(UserStatus), default=UserStatus.OFFLINE)
    last_login_at = Column(DateTime(timezone=True), nullable=True)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), server_default=func.now(), onupdate=func.now())

    # å…³ç³»
    notification_records = relationship("NotificationRecord", back_populates="user", cascade="all, delete-orphan")
```

### 2. ç«™å†…ä¿¡å†…å®¹è¡¨ (notifications)

```python
class Notification(Base):
    """ç«™å†…ä¿¡å†…å®¹è¡¨"""
    __tablename__ = "notifications"

    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4, index=True)
    type = Column(String(50), nullable=False, index=True, comment="ç«™å†…ä¿¡ç±»å‹")
    title = Column(String(200), nullable=False, comment="æ ‡é¢˜")
    content = Column(Text, nullable=False, comment="å†…å®¹")
    action_url = Column(String(500), nullable=True, comment="ç‚¹å‡»è·³è½¬é“¾æ¥")
    priority = Column(Integer, default=0, nullable=False, comment="ä¼˜å…ˆçº§ 0:æ™®é€š 1:é‡è¦ 2:ç´§æ€¥")
    created_by = Column(UUID(as_uuid=True), ForeignKey("users.id", ondelete="SET NULL"), nullable=True)
    created_at = Column(DateTime(timezone=True), server_default=func.now(), nullable=False)
    expires_at = Column(DateTime(timezone=True), nullable=True, comment="è¿‡æœŸæ—¶é—´")

    # å…³ç³»
    records = relationship("NotificationRecord", back_populates="notification", cascade="all, delete-orphan")
```

**è¡¨ç»“æ„**ï¼š

```sql
CREATE TABLE notifications (
    id              UUID PRIMARY KEY,        -- ç«™å†…ä¿¡ID
    type            VARCHAR(50),             -- ç±»å‹ï¼šsystem/business/reminder/announcement
    title           VARCHAR(200),            -- æ ‡é¢˜
    content         TEXT,                    -- å†…å®¹
    action_url      VARCHAR(500),            -- ç‚¹å‡»è·³è½¬é“¾æ¥
    priority        INTEGER DEFAULT 0,       -- ä¼˜å…ˆçº§ï¼š0æ™®é€š/1é‡è¦/2ç´§æ€¥
    created_by      UUID,                    -- åˆ›å»ºè€…ID
    created_at      TIMESTAMP,               -- åˆ›å»ºæ—¶é—´
    expires_at      TIMESTAMP                -- è¿‡æœŸæ—¶é—´ï¼ˆå¯é€‰ï¼‰
);
```

**ç«™å†…ä¿¡ç±»å‹**ï¼š
- `system`: ç³»ç»Ÿé€šçŸ¥
- `business`: ä¸šåŠ¡é€šçŸ¥
- `reminder`: æé†’é€šçŸ¥
- `announcement`: å…¬å‘Š

### 3. ç«™å†…ä¿¡ç”¨æˆ·è®°å½•è¡¨ (notification_records)

```python
class NotificationRecord(Base):
    """ç«™å†…ä¿¡ç”¨æˆ·è®°å½•è¡¨"""
    __tablename__ = "notification_records"

    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4, index=True)
    notification_id = Column(UUID(as_uuid=True), ForeignKey("notifications.id", ondelete="CASCADE"), nullable=False, index=True)
    user_id = Column(UUID(as_uuid=True), ForeignKey("users.id", ondelete="CASCADE"), nullable=False, index=True)
    is_read = Column(Boolean, default=False, nullable=False, comment="æ˜¯å¦å·²è¯»")
    read_at = Column(DateTime(timezone=True), nullable=True, comment="é˜…è¯»æ—¶é—´")
    is_deleted = Column(Boolean, default=False, nullable=False, comment="æ˜¯å¦å·²åˆ é™¤")
    deleted_at = Column(DateTime(timezone=True), nullable=True, comment="åˆ é™¤æ—¶é—´")
    created_at = Column(DateTime(timezone=True), server_default=func.now(), nullable=False)

    # å…³ç³»
    notification = relationship("Notification", back_populates="records")
    user = relationship("User", back_populates="notification_records")

    # å”¯ä¸€çº¦æŸï¼šä¸€ä¸ªç”¨æˆ·åªèƒ½æ”¶åˆ°ä¸€æ¬¡åŒä¸€æ¡ç«™å†…ä¿¡
    __table_args__ = (UniqueConstraint("notification_id", "user_id", name="unique_notification_user"),)
```

**è¡¨ç»“æ„**ï¼š

```sql
CREATE TABLE notification_records (
    id              UUID PRIMARY KEY,
    notification_id UUID,                    -- å…³è”ç«™å†…ä¿¡å†…å®¹
    user_id         UUID,                    -- æ¥æ”¶ç”¨æˆ·
    is_read         BOOLEAN DEFAULT FALSE,   -- æ˜¯å¦å·²è¯»
    read_at         TIMESTAMP,               -- é˜…è¯»æ—¶é—´
    is_deleted      BOOLEAN DEFAULT FALSE,   -- æ˜¯å¦åˆ é™¤ï¼ˆè½¯åˆ é™¤ï¼‰
    deleted_at      TIMESTAMP,               -- åˆ é™¤æ—¶é—´
    created_at      TIMESTAMP,               -- åˆ›å»ºæ—¶é—´

    UNIQUE(notification_id, user_id)        -- å”¯ä¸€çº¦æŸï¼šé˜²æ­¢é‡å¤å‘é€
);
```

## 2ï¸âƒ£ ä¸šåŠ¡é€»è¾‘å±‚

### ğŸ“Œ åˆ›å»ºç«™å†…ä¿¡

```python
@staticmethod
def create_notification(
    db: Session,
    notification_create: NotificationCreate,
    created_by_id: str,
) -> NotificationResponse:
    """
    åˆ›å»ºç«™å†…ä¿¡ï¼ˆä»…åˆ›å»ºå†…å®¹ï¼Œä¸å‘é€ç»™ç”¨æˆ·ï¼‰
    """
    notification = Notification(
        type=notification_create.type,
        title=notification_create.title,
        content=notification_create.content,
        action_url=notification_create.action_url,
        priority=notification_create.priority,
        created_by=created_by_id,
        expires_at=notification_create.expires_at,
    )
    db.add(notification)
    db.commit()
    db.refresh(notification)

    return NotificationResponse.model_validate(notification)
```

**æµç¨‹**ï¼š
1. åˆ›å»º `Notification` å¯¹è±¡
2. æ’å…¥åˆ°æ•°æ®åº“
3. è¿”å›ç«™å†…ä¿¡ä¿¡æ¯ï¼ˆä½†è¿˜æœªå‘é€ç»™ä»»ä½•ç”¨æˆ·ï¼‰

### ğŸ“Œ å‘é€ç«™å†…ä¿¡ç»™ç”¨æˆ·

```python
@staticmethod
def send_to_users(
    db: Session,
    notification_id: str,
    user_ids: List[str],
) -> int:
    """
    å‘é€ç«™å†…ä¿¡ç»™æŒ‡å®šç”¨æˆ·
    """
    # 1. éªŒè¯ç«™å†…ä¿¡æ˜¯å¦å­˜åœ¨
    notification = db.query(Notification).filter(Notification.id == notification_id).first()
    if not notification:
        raise HTTPException(status_code=404, detail="ç«™å†…ä¿¡ä¸å­˜åœ¨")

    # 2. æ‰¹é‡åˆ›å»ºç”¨æˆ·è®°å½•
    records = []
    for user_id in user_ids:
        # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼ˆé˜²æ­¢é‡å¤å‘é€ï¼‰
        existing = db.query(NotificationRecord).filter(
            NotificationRecord.notification_id == notification_id,
            NotificationRecord.user_id == user_id,
        ).first()

        if not existing:  # ä¸å­˜åœ¨æ‰åˆ›å»º
            records.append(NotificationRecord(
                notification_id=notification_id,
                user_id=user_id,
            ))

    # 3. æ‰¹é‡æ’å…¥æ•°æ®åº“ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
    db.bulk_save_objects(records)
    db.commit()

    return len(records)  # è¿”å›æˆåŠŸå‘é€æ•°é‡
```

**å…³é”®ç‚¹**ï¼š
1. **å»é‡æ£€æŸ¥**ï¼šé€šè¿‡æ•°æ®åº“æŸ¥è¯¢é˜²æ­¢é‡å¤å‘é€
2. **æ‰¹é‡æ’å…¥**ï¼šä½¿ç”¨ `bulk_save_objects` æé«˜æ€§èƒ½
3. **äº‹åŠ¡å¤„ç†**ï¼šå…¨éƒ¨æˆåŠŸæˆ–å…¨éƒ¨å¤±è´¥

### ğŸ“Œ å‘é€ç»™æ‰€æœ‰ç”¨æˆ·

```python
@staticmethod
def send_to_all_users(db: Session, notification_id: str) -> int:
    """
    å‘é€ç«™å†…ä¿¡ç»™æ‰€æœ‰ç”¨æˆ·
    """
    # 1. éªŒè¯ç«™å†…ä¿¡æ˜¯å¦å­˜åœ¨
    notification = db.query(Notification).filter(Notification.id == notification_id).first()
    if not notification:
        raise HTTPException(status_code=404, detail="ç«™å†…ä¿¡ä¸å­˜åœ¨")

    # 2. è·å–æ‰€æœ‰ç”¨æˆ· ID
    all_users = db.query(User.id).all()
    user_ids = [str(user.id) for user in all_users]

    # 3. è°ƒç”¨ send_to_users æ‰¹é‡å‘é€
    return NotificationService.send_to_users(db, notification_id, user_ids)
```

### ğŸ“Œ æŸ¥è¯¢ç”¨æˆ·çš„ç«™å†…ä¿¡åˆ—è¡¨

```python
@staticmethod
def get_user_notifications(
    db: Session,
    user_id: str,
    is_read: Optional[bool] = None,
    notification_type: Optional[str] = None,
    skip: int = 0,
    limit: int = 20,
) -> NotificationRecordListResponse:
    """
    è·å–ç”¨æˆ·çš„ç«™å†…ä¿¡åˆ—è¡¨ï¼ˆæ”¯æŒç­›é€‰ã€åˆ†é¡µï¼‰
    """
    # 1. æ„å»ºåŸºç¡€æŸ¥è¯¢
    query = db.query(NotificationRecord)\
        .filter(
            NotificationRecord.user_id == user_id,
            NotificationRecord.is_deleted == False  # è¿‡æ»¤å·²åˆ é™¤
        )\
        .join(Notification)  # å…³è”æŸ¥è¯¢ç«™å†…ä¿¡å†…å®¹

    # 2. åŠ¨æ€ç­›é€‰æ¡ä»¶
    if is_read is not None:  # åªæŸ¥å·²è¯»/æœªè¯»
        query = query.filter(NotificationRecord.is_read == is_read)

    if notification_type:  # æŒ‰ç±»å‹ç­›é€‰
        query = query.filter(Notification.type == notification_type)

    # 3. æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
    query = query.order_by(NotificationRecord.created_at.desc())

    # 4. ç»Ÿè®¡æ€»æ•°å’Œæœªè¯»æ•°
    total = query.count()

    unread_count = db.query(NotificationRecord).filter(
        NotificationRecord.user_id == user_id,
        NotificationRecord.is_read == False,
        NotificationRecord.is_deleted == False,
    ).count()

    # 5. åˆ†é¡µæŸ¥è¯¢
    records = query.offset(skip).limit(limit).all()

    # 6. è½¬æ¢ä¸ºå“åº”æ ¼å¼
    items = [NotificationRecordResponse.model_validate(record) for record in records]

    return NotificationRecordListResponse(
        total=total,
        unread_count=unread_count,
        items=items,
    )
```

**æŸ¥è¯¢æµç¨‹**ï¼š
```
ç”¨æˆ·AæŸ¥è¯¢ç«™å†…ä¿¡åˆ—è¡¨
    â”‚
    â”œâ”€ æŸ¥è¯¢ notification_records è¡¨ï¼ˆuser_id = A, is_deleted = falseï¼‰
    â”‚
    â”œâ”€ å…³è” notifications è¡¨ï¼ˆè·å–æ ‡é¢˜ã€å†…å®¹ç­‰ï¼‰
    â”‚
    â”œâ”€ åº”ç”¨ç­›é€‰æ¡ä»¶ï¼ˆå·²è¯»/æœªè¯»ã€ç±»å‹ï¼‰
    â”‚
    â”œâ”€ æŒ‰æ—¶é—´å€’åºæ’åº
    â”‚
    â””â”€ åˆ†é¡µè¿”å›
```

### ğŸ“Œ æ ‡è®°å·²è¯»

```python
@staticmethod
def mark_as_read(db: Session, user_id: str, record_id: str) -> None:
    """
    æ ‡è®°ç«™å†…ä¿¡ä¸ºå·²è¯»
    """
    # 1. æŸ¥è¯¢ç«™å†…ä¿¡è®°å½•ï¼ˆéªŒè¯æƒé™ï¼‰
    record = db.query(NotificationRecord).filter(
        NotificationRecord.id == record_id,
        NotificationRecord.user_id == user_id,  # éªŒè¯æ˜¯å¦æ˜¯è‡ªå·±çš„ç«™å†…ä¿¡
        NotificationRecord.is_deleted == False,
    ).first()

    if not record:
        raise HTTPException(status_code=404, detail="ç«™å†…ä¿¡ä¸å­˜åœ¨")

    # 2. æ›´æ–°å·²è¯»çŠ¶æ€ï¼ˆåªåœ¨æœªè¯»æ—¶æ›´æ–°ï¼‰
    if not record.is_read:
        record.is_read = True
        record.read_at = datetime.utcnow()  # è®°å½•é˜…è¯»æ—¶é—´
        db.commit()

@staticmethod
def mark_all_as_read(db: Session, user_id: str) -> int:
    """
    æ ‡è®°æ‰€æœ‰ç«™å†…ä¿¡ä¸ºå·²è¯»
    """
    # 1. æŸ¥è¯¢æ‰€æœ‰æœªè¯»ç«™å†…ä¿¡
    unread_records = db.query(NotificationRecord).filter(
        NotificationRecord.user_id == user_id,
        NotificationRecord.is_read == False,
        NotificationRecord.is_deleted == False,
    ).all()

    # 2. æ‰¹é‡æ›´æ–°
    count = 0
    for record in unread_records:
        record.is_read = True
        record.read_at = datetime.utcnow()
        count += 1

    db.commit()
    return count  # è¿”å›æ ‡è®°æ•°é‡
```

### ğŸ“Œ è½¯åˆ é™¤

```python
@staticmethod
def delete_notification_record(db: Session, user_id: str, record_id: str) -> None:
    """
    åˆ é™¤ç«™å†…ä¿¡ï¼ˆè½¯åˆ é™¤ï¼‰
    """
    record = db.query(NotificationRecord).filter(
        NotificationRecord.id == record_id,
        NotificationRecord.user_id == user_id,
    ).first()

    if not record:
        raise HTTPException(status_code=404, detail="ç«™å†…ä¿¡ä¸å­˜åœ¨")

    # è½¯åˆ é™¤ï¼šåªæ ‡è®°ï¼Œä¸ç‰©ç†åˆ é™¤
    record.is_deleted = True
    record.deleted_at = datetime.utcnow()
    db.commit()
```

## 3ï¸âƒ£ API å±‚å®ç°

### ç”¨æˆ·ç«¯ API

```python
from fastapi import APIRouter, Depends, Query
from sqlalchemy.orm import Session

router = APIRouter()

@router.get("", response_model=NotificationRecordListResponse)
async def get_notifications(
    is_read: Optional[bool] = Query(None, description="ç­›é€‰å·²è¯»/æœªè¯»"),
    notification_type: Optional[str] = Query(None, description="ç«™å†…ä¿¡ç±»å‹"),
    page: int = Query(1, ge=1, description="é¡µç "),
    page_size: int = Query(20, ge=1, le=100, description="æ¯é¡µæ•°é‡"),
    current_user: User = Depends(get_current_user),  # JWT è®¤è¯
    db: Session = Depends(get_db),
):
    """
    è·å–å½“å‰ç”¨æˆ·çš„ç«™å†…ä¿¡åˆ—è¡¨
    """
    skip = (page - 1) * page_size
    return NotificationService.get_user_notifications(
        db,
        user_id=str(current_user.id),
        is_read=is_read,
        notification_type=notification_type,
        skip=skip,
        limit=page_size,
    )

@router.get("/unread-count")
async def get_unread_count(
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db),
):
    """è·å–æœªè¯»ç«™å†…ä¿¡æ•°é‡"""
    count = NotificationService.get_unread_count(db, str(current_user.id))
    return {"unread_count": count}

@router.post("/{record_id}/read", status_code=204)
async def mark_notification_as_read(
    record_id: str,
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db),
):
    """æ ‡è®°ç«™å†…ä¿¡ä¸ºå·²è¯»"""
    NotificationService.mark_as_read(db, str(current_user.id), record_id)
    return None

@router.post("/read-all")
async def mark_all_notifications_as_read(
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db),
):
    """å…¨éƒ¨æ ‡è®°å·²è¯»"""
    count = NotificationService.mark_all_as_read(db, str(current_user.id))
    return {"message": f"å·²å°† {count} æ¡ç«™å†…ä¿¡æ ‡è®°ä¸ºå·²è¯»"}

@router.delete("/{record_id}", status_code=204)
async def delete_notification(
    record_id: str,
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db),
):
    """åˆ é™¤ç«™å†…ä¿¡ï¼ˆè½¯åˆ é™¤ï¼‰"""
    NotificationService.delete_notification_record(db, str(current_user.id), record_id)
    return None
```

### ç®¡ç†ç«¯ API

```python
admin_router = APIRouter()

@admin_router.post("/notifications", response_model=NotificationResponse, status_code=201)
async def create_notification(
    notification_create: NotificationCreate,
    current_user: User = Depends(require_admin),  # éœ€è¦ç®¡ç†å‘˜æƒé™
    db: Session = Depends(get_db),
):
    """åˆ›å»ºç«™å†…ä¿¡"""
    return NotificationService.create_notification(
        db,
        notification_create,
        created_by_id=str(current_user.id),
    )

@admin_router.post("/notifications/{notification_id}/send")
async def send_notification(
    notification_id: str,
    send_request: NotificationSendRequest,
    current_user: User = Depends(require_admin),
    db: Session = Depends(get_db),
):
    """å‘é€ç«™å†…ä¿¡ç»™ç”¨æˆ·"""
    if send_request.send_to_all:
        count = NotificationService.send_to_all_users(db, notification_id)
    else:
        count = NotificationService.send_to_users(db, notification_id, send_request.user_ids)

    return {"message": f"æˆåŠŸå‘é€ç»™ {count} ä¸ªç”¨æˆ·"}
```

## 4ï¸âƒ£ å®Œæ•´çš„ä¸šåŠ¡æµç¨‹

### åœºæ™¯ 1ï¼šç®¡ç†å‘˜å‘é€ç«™å†…ä¿¡ç»™ç”¨æˆ·

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ç®¡ç†å‘˜åˆ›å»ºç«™å†…ä¿¡                                           â”‚
â”‚     POST /api/v1/admin/notifications                          â”‚
â”‚     {                                                         â”‚
â”‚       "type": "system",                                       â”‚
â”‚       "title": "ç³»ç»Ÿç»´æŠ¤é€šçŸ¥",                                 â”‚
â”‚       "content": "ä»Šæ™š22:00ç³»ç»Ÿç»´æŠ¤"                           â”‚
â”‚     }                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. NotificationService.create_notification()                â”‚
â”‚     - åˆ›å»º Notification è®°å½•                                  â”‚
â”‚     - è¿”å› notification_id: "msg_001"                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. ç®¡ç†å‘˜å‘é€ç«™å†…ä¿¡                                           â”‚
â”‚     POST /api/v1/admin/notifications/msg_001/send             â”‚
â”‚     {                                                         â”‚
â”‚       "user_ids": ["user_A", "user_B", "user_C"],             â”‚
â”‚       "send_to_all": false                                    â”‚
â”‚     }                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. NotificationService.send_to_users()                       â”‚
â”‚     For each user_id:                                         â”‚
â”‚       - æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ (é˜²æ­¢é‡å¤)                               â”‚
â”‚       - åˆ›å»º NotificationRecord                               â”‚
â”‚         { notification_id: "msg_001", user_id: "user_A" }     â”‚
â”‚         { notification_id: "msg_001", user_id: "user_B" }     â”‚
â”‚         { notification_id: "msg_001", user_id: "user_C" }     â”‚
â”‚     - æ‰¹é‡æ’å…¥æ•°æ®åº“                                          â”‚
â”‚     - è¿”å›æˆåŠŸå‘é€æ•°é‡: 3                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åœºæ™¯ 2ï¼šç”¨æˆ·æŸ¥çœ‹ç«™å†…ä¿¡åˆ—è¡¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ç”¨æˆ·è¯·æ±‚ç«™å†…ä¿¡åˆ—è¡¨                                         â”‚
â”‚     GET /api/v1/notifications?page=1&page_size=20             â”‚
â”‚     Authorization: Bearer <jwt_token>                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. JWT è®¤è¯ä¸­é—´ä»¶                                             â”‚
â”‚     - éªŒè¯ Token æœ‰æ•ˆæ€§                                       â”‚
â”‚     - è§£æå‡º user_id: "user_A"                                â”‚
â”‚     - æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. NotificationService.get_user_notifications()             â”‚
â”‚     - æŸ¥è¯¢ç”¨æˆ·çš„ notification_records                         â”‚
â”‚     - å…³è” notifications è¡¨è·å–å†…å®¹                            â”‚
â”‚     - è¿‡æ»¤å·²åˆ é™¤ (is_deleted = false)                          â”‚
â”‚     - æŒ‰åˆ›å»ºæ—¶é—´å€’åºæ’åº                                       â”‚
â”‚     - ç»Ÿè®¡æœªè¯»æ•°é‡                                            â”‚
â”‚     - åˆ†é¡µè¿”å›                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. è¿”å›æ•°æ®                                                   â”‚
â”‚     {                                                         â”‚
â”‚       "total": 100,                                           â”‚
â”‚       "unread_count": 5,                                      â”‚
â”‚       "items": [                                              â”‚
â”‚         {                                                     â”‚
â”‚           "id": "record_001",                                 â”‚
â”‚           "notification": {                                   â”‚
â”‚             "id": "msg_001",                                  â”‚
â”‚             "title": "ç³»ç»Ÿç»´æŠ¤é€šçŸ¥",                           â”‚
â”‚             "content": "ä»Šæ™š22:00ç³»ç»Ÿç»´æŠ¤"                     â”‚
â”‚           },                                                  â”‚
â”‚           "is_read": false,                                   â”‚
â”‚           "created_at": "2025-02-07T10:00:00Z"                â”‚
â”‚         },                                                    â”‚
â”‚         ...                                                   â”‚
â”‚       ]                                                       â”‚
â”‚     }                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åœºæ™¯ 3ï¼šç”¨æˆ·æ ‡è®°å·²è¯»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ç”¨æˆ·æ ‡è®°ç«™å†…ä¿¡ä¸ºå·²è¯»                                       â”‚
â”‚     POST /api/v1/notifications/record_001/read                â”‚
â”‚     Authorization: Bearer <jwt_token>                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. NotificationService.mark_as_read()                        â”‚
â”‚     - æŸ¥è¯¢ç«™å†…ä¿¡è®°å½• (record_001)                              â”‚
â”‚     - éªŒè¯æ˜¯å¦å±äºå½“å‰ç”¨æˆ· (user_id == user_A)                 â”‚
â”‚     - æ›´æ–°: is_read = true, read_at = now()                   â”‚
â”‚     - æäº¤äº‹åŠ¡                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. è¿”å› 204 No Content                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 5ï¸âƒ£ å…³é”®æŠ€æœ¯ç‚¹æ€»ç»“

### âœ… 1. å†…å®¹ä¸è®°å½•åˆ†ç¦»

**å®ç°**ï¼š
- `notifications` è¡¨ï¼šå­˜å‚¨ç«™å†…ä¿¡å†…å®¹ï¼ˆ1 ä»½ï¼‰
- `notification_records` è¡¨ï¼šå­˜å‚¨ç”¨æˆ·æ¥æ”¶è®°å½•ï¼ˆN ä»½ï¼‰

**å¥½å¤„**ï¼š
- èŠ‚çœå­˜å‚¨ç©ºé—´
- é¿å…æ•°æ®å†—ä½™
- ä¾¿äºä¿®æ”¹å†…å®¹

### âœ… 2. é˜²æ­¢é‡å¤å‘é€

**æ•°æ®åº“å±‚é¢**ï¼š
```sql
UNIQUE(notification_id, user_id)
```

**ä»£ç å±‚é¢**ï¼š
```python
existing = db.query(NotificationRecord).filter(
    NotificationRecord.notification_id == notification_id,
    NotificationRecord.user_id == user_id,
).first()

if not existing:
    # åªæœ‰ä¸å­˜åœ¨æ—¶æ‰åˆ›å»º
    records.append(NotificationRecord(...))
```

### âœ… 3. è½¯åˆ é™¤

**åˆ é™¤æ—¶**ï¼š
```python
# åªæ ‡è®°ä¸ç‰©ç†åˆ é™¤
record.is_deleted = True
record.deleted_at = datetime.utcnow()
```

**æŸ¥è¯¢æ—¶**ï¼š
```python
# è¿‡æ»¤å·²åˆ é™¤çš„è®°å½•
.filter(NotificationRecord.is_deleted == False)
```

**å¥½å¤„**ï¼š
- æ•°æ®å¯æ¢å¤
- ä¿ç•™å®¡è®¡æ—¥å¿—
- å¯ç”¨äºç»Ÿè®¡åˆ†æ

### âœ… 4. çº§è”åˆ é™¤

**å®šä¹‰**ï¼š
```python
notification_id = Column(
    UUID(as_uuid=True),
    ForeignKey("notifications.id", ondelete="CASCADE"),
    nullable=False
)
```

**æ•ˆæœ**ï¼š
- åˆ é™¤ `notifications` è®°å½•æ—¶
- è‡ªåŠ¨åˆ é™¤æ‰€æœ‰å…³è”çš„ `notification_records`

### âœ… 5. æ€§èƒ½ä¼˜åŒ–

**æ‰¹é‡æ’å…¥**ï¼š
```python
# ä½¿ç”¨æ‰¹é‡æ’å…¥ä»£æ›¿é€æ¡æ’å…¥
db.bulk_save_objects(records)
db.commit()
```

**ç´¢å¼•ä¼˜åŒ–**ï¼š
```python
# åœ¨å¸¸ç”¨æŸ¥è¯¢å­—æ®µä¸Šå»ºç«‹ç´¢å¼•
index=True  # user_id, notification_id, is_read, created_at
```

**åˆ†é¡µæŸ¥è¯¢**ï¼š
```python
# é¿å…ä¸€æ¬¡æ€§åŠ è½½å¤§é‡æ•°æ®
records = query.offset(skip).limit(limit).all()
```

**å…³è”æŸ¥è¯¢ä¼˜åŒ–**ï¼š
```python
# ä½¿ç”¨ join é¿å… N+1 æŸ¥è¯¢
query = db.query(NotificationRecord)\
    .join(Notification)\
    .filter(...)
```

### âœ… 6. æƒé™æ§åˆ¶

**éªŒè¯ç”¨æˆ·æƒé™**ï¼š
```python
# æŸ¥è¯¢æ—¶éªŒè¯ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„ç«™å†…ä¿¡
.filter(NotificationRecord.user_id == user_id)
```

**JWT è®¤è¯**ï¼š
```python
# API å±‚ä½¿ç”¨ä¾èµ–æ³¨å…¥è¿›è¡Œè®¤è¯
@router.get("/notifications")
async def get_notifications(
    current_user: User = Depends(get_current_user)  # è‡ªåŠ¨éªŒè¯ Token
):
    return NotificationService.get_user_notifications(
        db,
        user_id=str(current_user.id)  # ä½¿ç”¨è®¤è¯åçš„ç”¨æˆ· ID
    )
```

## ğŸ¯ æ€»ç»“

ç«™å†…ä¿¡ç³»ç»Ÿçš„æ ¸å¿ƒå®ç°å°±æ˜¯ï¼š

### æ ¸å¿ƒç»„ä»¶
1. **ä¸¤å¼ è¡¨**ï¼š`notifications`ï¼ˆå†…å®¹ï¼‰+ `notification_records`ï¼ˆè®°å½•ï¼‰
2. **ä¸€ä¸ªæœåŠ¡**ï¼š`NotificationService` å¤„ç†æ‰€æœ‰ä¸šåŠ¡é€»è¾‘
3. **ä¸€ç»„ API**ï¼šRESTful æ¥å£ä¾›å‰ç«¯è°ƒç”¨

### å…³é”®ç‰¹æ€§
- âœ… å†…å®¹ä¸è®°å½•åˆ†ç¦»ï¼ˆé¿å…å†—ä½™ï¼‰
- âœ… é˜²æ­¢é‡å¤å‘é€ï¼ˆå”¯ä¸€çº¦æŸ + ä»£ç æ£€æŸ¥ï¼‰
- âœ… è½¯åˆ é™¤ï¼ˆå¯æ¢å¤ã€ä¿ç•™å®¡è®¡ï¼‰
- âœ… çº§è”åˆ é™¤ï¼ˆæ•°æ®ä¸€è‡´æ€§ï¼‰
- âœ… åˆ†é¡µç­›é€‰ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
- âœ… æƒé™æ§åˆ¶ï¼ˆJWT è®¤è¯ï¼‰

### é€‚ç”¨åœºæ™¯
- ç³»ç»Ÿé€šçŸ¥ï¼ˆç»´æŠ¤ã€å‡çº§ã€è­¦å‘Šï¼‰
- ä¸šåŠ¡é€šçŸ¥ï¼ˆè®¢å•çŠ¶æ€ã€å®¡æ‰¹æµç¨‹ï¼‰
- æé†’é€šçŸ¥ï¼ˆä¼šè®®ã€å¾…åŠäº‹é¡¹ï¼‰
- å…¬å‘Šé€šçŸ¥ï¼ˆæ´»åŠ¨ã€æ”¿ç­–å˜æ›´ï¼‰

è¿™ä¸ªè®¾è®¡æ—¢ç®€å•åˆé«˜æ•ˆï¼Œé€‚ç”¨äºå¤§å¤šæ•°ç«™å†…ä¿¡åœºæ™¯ï¼ğŸ‰
