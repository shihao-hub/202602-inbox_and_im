# ç«™å†…ä¿¡ç³»ç»Ÿæµ‹è¯•åœºæ™¯æŒ‡å—

æœ¬ç›®å½•åŒ…å«åŸºäºåœºæ™¯çš„ pytest æµ‹è¯•ç”¨ä¾‹,æ¯ä¸ªæµ‹è¯•æ–‡ä»¶ä»£è¡¨ä¸€ä¸ªå®Œæ•´çš„ç”¨æˆ·è¡Œä¸ºæµç¨‹ã€‚

## ğŸ“ æµ‹è¯•æ–‡ä»¶è¯´æ˜

### ç”¨æˆ·æ³¨å†Œç™»å½•åœºæ™¯
**æ–‡ä»¶**: `test_user_registration_and_login.py`

æµ‹è¯•ç”¨æˆ·ä»æ³¨å†Œåˆ°ç™»å½•çš„å®Œæ•´æµç¨‹:
- æ–°ç”¨æˆ·æ³¨å†Œ
- ä½¿ç”¨ç”¨æˆ·åæˆ–é‚®ç®±ç™»å½•
- è·å–å’ŒéªŒè¯ access token
- ç”¨æˆ·ç™»å‡ºæµç¨‹
- é‡å¤æ³¨å†Œå’Œç™»å½•å¤±è´¥åœºæ™¯

### ç®¡ç†å‘˜åˆ›å»ºå‘é€ç«™å†…ä¿¡åœºæ™¯
**æ–‡ä»¶**: `test_admin_create_and_send_notification.py`

æµ‹è¯•ç®¡ç†å‘˜åˆ›å»ºå’Œå‘é€ç«™å†…ä¿¡çš„å®Œæ•´æµç¨‹:
- åˆ›å»ºç«™å†…ä¿¡å†…å®¹
- å‘é€ç»™å•ä¸ªç”¨æˆ·
- å‘é€ç»™æ‰€æœ‰ç”¨æˆ·
- åˆ›å»ºä¸åŒç±»å‹çš„ç«™å†…ä¿¡ (system/business/reminder/announcement)
- è®¾ç½®è¿‡æœŸæ—¶é—´å’Œä¼˜å…ˆçº§
- æŸ¥çœ‹ç«™å†…ä¿¡åˆ—è¡¨å’Œè¯¦æƒ…

### ç”¨æˆ·æ¥æ”¶é˜…è¯»ç«™å†…ä¿¡åœºæ™¯
**æ–‡ä»¶**: `test_user_receive_and_read_notifications.py`

æµ‹è¯•ç”¨æˆ·æ¥æ”¶å’Œé˜…è¯»ç«™å†…ä¿¡çš„å®Œæ•´æµç¨‹:
- æ¥æ”¶ç«™å†…ä¿¡
- æŸ¥çœ‹ç«™å†…ä¿¡åˆ—è¡¨
- æŸ¥çœ‹ç«™å†…ä¿¡è¯¦æƒ…
- æ ‡è®°å•æ¡ç«™å†…ä¿¡ä¸ºå·²è¯»
- ä½¿ç”¨åˆ†é¡µæŸ¥çœ‹ç«™å†…ä¿¡

### ç”¨æˆ·æ‰¹é‡ç®¡ç†ç«™å†…ä¿¡åœºæ™¯
**æ–‡ä»¶**: `test_user_batch_manage_notifications.py`

æµ‹è¯•ç”¨æˆ·æ‰¹é‡ç®¡ç†ç«™å†…ä¿¡çš„å®Œæ•´æµç¨‹:
- å…¨éƒ¨æ ‡è®°ä¸ºå·²è¯»
- é€æ¡é˜…è¯»ç«™å†…ä¿¡
- éƒ¨åˆ†å·²è¯»æ—¶çš„æ‰¹é‡æ“ä½œ
- æ ‡è®°å·²è¯»ååˆæ”¶åˆ°æ–°ç«™å†…ä¿¡

### ç®¡ç†å‘˜ç¼–è¾‘ç«™å†…ä¿¡åœºæ™¯
**æ–‡ä»¶**: `test_admin_edit_notifications.py`

æµ‹è¯•ç®¡ç†å‘˜ç¼–è¾‘å’Œåˆ é™¤ç«™å†…ä¿¡çš„å®Œæ•´æµç¨‹:
- æ›´æ–°ç«™å†…ä¿¡å†…å®¹
- éƒ¨åˆ†æ›´æ–°å­—æ®µ
- æ›´æ–°ç«™å†…ä¿¡ç±»å‹å’Œè¿‡æœŸæ—¶é—´
- åˆ é™¤ç«™å†…ä¿¡
- æ›´æ–°åé‡æ–°å‘é€

### ç”¨æˆ·åˆ é™¤ç«™å†…ä¿¡åœºæ™¯
**æ–‡ä»¶**: `test_user_delete_notifications.py`

æµ‹è¯•ç”¨æˆ·åˆ é™¤ç«™å†…ä¿¡çš„å®Œæ•´æµç¨‹:
- åˆ é™¤å•æ¡ç«™å†…ä¿¡
- åˆ é™¤å¤šæ¡ç«™å†…ä¿¡
- åˆ é™¤æ‰€æœ‰ç«™å†…ä¿¡
- åˆ é™¤å·²è¯»å’Œæœªè¯»ç«™å†…ä¿¡
- åˆ é™¤åæ¥æ”¶æ–°ç«™å†…ä¿¡

### ç«™å†…ä¿¡ç­›é€‰åŠŸèƒ½åœºæ™¯
**æ–‡ä»¶**: `test_notification_filtering.py`

æµ‹è¯•ç«™å†…ä¿¡ç­›é€‰å’Œåˆ†é¡µåŠŸèƒ½:
- æŒ‰å·²è¯»/æœªè¯»çŠ¶æ€ç­›é€‰
- æŒ‰ç«™å†…ä¿¡ç±»å‹ç­›é€‰
- ç»„åˆç­›é€‰æ¡ä»¶
- ç­›é€‰ç»“æœåˆ†é¡µ
- æ— æ•ˆå‚æ•°å¤„ç†

## ğŸš€ è¿è¡Œæµ‹è¯•

### å®‰è£…ä¾èµ–

```bash
# å®‰è£…å¼€å‘ä¾èµ–
pip install pytest
```

### è¿è¡Œæ‰€æœ‰åœºæ™¯æµ‹è¯•

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œ
pytest tests/scenarios/ -v
```

### è¿è¡Œç‰¹å®šåœºæ™¯æµ‹è¯•

```bash
# åªè¿è¡Œç”¨æˆ·æ³¨å†Œç™»å½•åœºæ™¯
pytest tests/scenarios/test_user_registration_and_login.py -v

# åªè¿è¡Œç®¡ç†å‘˜åˆ›å»ºå‘é€ç«™å†…ä¿¡åœºæ™¯
pytest tests/scenarios/test_admin_create_and_send_notification.py -v

# åªè¿è¡Œç”¨æˆ·æ¥æ”¶é˜…è¯»ç«™å†…ä¿¡åœºæ™¯
pytest tests/scenarios/test_user_receive_and_read_notifications.py -v
```

### è¿è¡Œç‰¹å®šæµ‹è¯•ç”¨ä¾‹

```bash
# è¿è¡Œå•ä¸ªæµ‹è¯•ç”¨ä¾‹
pytest tests/scenarios/test_user_registration_and_login.py::test_new_user_complete_registration_flow -v

# ä½¿ç”¨ -k å…³é”®å­—è¿‡æ»¤
pytest tests/scenarios/ -k "register" -v
pytest tests/scenarios/ -k "send_notification" -v
```

### æŸ¥çœ‹æµ‹è¯•è¦†ç›–ç‡

```bash
# å®‰è£… pytest-cov
pip install pytest-cov

# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
pytest tests/scenarios/ --cov=app --cov-report=html

# æŸ¥çœ‹æŠ¥å‘Š
# æ‰“å¼€ htmlcov/index.html
```

### æ˜¾ç¤ºè¯¦ç»†è¾“å‡º

```bash
# æ˜¾ç¤º print è¾“å‡º
pytest tests/scenarios/ -v -s

# æ˜¾ç¤ºæ›´è¯¦ç»†çš„ä¿¡æ¯
pytest tests/scenarios/ -vv
```

### å¹¶è¡Œè¿è¡Œæµ‹è¯•ï¼ˆåŠ å¿«é€Ÿåº¦ï¼‰

```bash
# å®‰è£… pytest-xdist
pip install pytest-xdist

# ä½¿ç”¨å¤šè¿›ç¨‹è¿è¡Œ
pytest tests/scenarios/ -n auto
```

## ğŸ“Š æµ‹è¯•ç»“æœç¤ºä¾‹

```
tests/scenarios/test_user_registration_and_login.py::test_new_user_complete_registration_flow PASSED
tests/scenarios/test_user_registration_and_login.py::test_login_with_email_instead_of_username PASSED
tests/scenarios/test_admin_create_and_send_notification.py::test_admin_create_and_send_notification_to_single_user PASSED
tests/scenarios/test_user_receive_and_read_notifications.py::test_user_receive_and_read_notification_flow PASSED

======================== 42 passed in 2.34s ========================
```

## ğŸ› ï¸ ç¼–å†™æ–°çš„æµ‹è¯•åœºæ™¯

### æµ‹è¯•æ–‡ä»¶æ¨¡æ¿

```python
"""
æµ‹è¯•åœºæ™¯æè¿°

è¿™ä¸ªåœºæ™¯æ¨¡æ‹Ÿäº†...
"""

import pytest


def test_scenario_name(client, auth_headers, db_session, test_user):
    """
    åœºæ™¯ï¼šåœºæ™¯æè¿°
    =============
    1. ç¬¬ä¸€æ­¥
    2. ç¬¬äºŒæ­¥
    3. éªŒè¯ç»“æœ
    """
    # æ­¥éª¤ 1: ...
    # æ­¥éª¤ 2: ...
    # éªŒè¯: ...
    assert True
```

### å¯ç”¨çš„ Fixtures

- `client`: FastAPI æµ‹è¯•å®¢æˆ·ç«¯
- `db_session`: æ•°æ®åº“ä¼šè¯
- `test_user`: æµ‹è¯•ç”¨æˆ·
- `auth_headers`: ç”¨æˆ·è®¤è¯å¤´
- `admin_user`: ç®¡ç†å‘˜ç”¨æˆ·
- `admin_auth_headers`: ç®¡ç†å‘˜è®¤è¯å¤´
- `multiple_users`: å¤šä¸ªæµ‹è¯•ç”¨æˆ·
- `user_auth_headers`: å¤šä¸ªç”¨æˆ·çš„è®¤è¯å¤´

### æµ‹è¯•æœ€ä½³å®è·µ

1. **ä½¿ç”¨æè¿°æ€§çš„æµ‹è¯•å‡½æ•°å**: æ¸…æ¥šè¯´æ˜æµ‹è¯•çš„åœºæ™¯
2. **æ·»åŠ æ–‡æ¡£å­—ç¬¦ä¸²**: è¯¦ç»†æè¿°æµ‹è¯•æ­¥éª¤
3. **éµå¾ª AAA æ¨¡å¼**: Arrangeï¼ˆå‡†å¤‡ï¼‰â†’ Actï¼ˆæ‰§è¡Œï¼‰â†’ Assertï¼ˆéªŒè¯ï¼‰
4. **ä½¿ç”¨ fixtures å¤ç”¨ä»£ç **: é¿å…é‡å¤åˆ›å»ºç”¨æˆ·ã€ç™»å½•ç­‰
5. **æµ‹è¯•è¾¹ç•Œæƒ…å†µ**: ä¸ä»…æµ‹è¯•æ­£å¸¸æµç¨‹,ä¹Ÿè¦æµ‹è¯•é”™è¯¯åœºæ™¯
6. **ä¿æŒæµ‹è¯•ç‹¬ç«‹**: æ¯ä¸ªæµ‹è¯•åº”è¯¥èƒ½å¤Ÿç‹¬ç«‹è¿è¡Œ

## ğŸ“ æµ‹è¯•æ•°æ®è¯´æ˜

### æµ‹è¯•æ•°æ®åº“

æµ‹è¯•ä½¿ç”¨ SQLite å†…å­˜æ•°æ®åº“ (`test.db`),æ¯æ¬¡æµ‹è¯•è¿è¡Œéƒ½ä¼š:
1. åˆ›å»ºæ‰€æœ‰è¡¨
2. è¿è¡Œæµ‹è¯•
3. åˆ é™¤æ‰€æœ‰è¡¨

è¿™æ ·å¯ä»¥ç¡®ä¿æ¯ä¸ªæµ‹è¯•éƒ½åœ¨å¹²å‡€çš„ç¯å¢ƒä¸­è¿è¡Œã€‚

### æµ‹è¯•ç”¨æˆ·

é»˜è®¤æµ‹è¯•ç”¨æˆ·:
- ç”¨æˆ·å: `testuser`
- é‚®ç®±: `test@example.com`
- å¯†ç : `password123`

ç®¡ç†å‘˜ç”¨æˆ·:
- ç”¨æˆ·å: `admin`
- é‚®ç®±: `admin@example.com`
- å¯†ç : `adminpass123`

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [API æ–‡æ¡£](../../docs/api-design.md)
- [æ•°æ®åº“è®¾è®¡](../../docs/database-design.md)
- [é¡¹ç›® README](../../README.md)

## â“ å¸¸è§é—®é¢˜

### Q: æµ‹è¯•å¤±è´¥æ€ä¹ˆåŠ?

A: æŸ¥çœ‹å¤±è´¥ä¿¡æ¯çš„è¯¦ç»†è¾“å‡º:
```bash
pytest tests/scenarios/ -v --tb=short
```

### Q: å¦‚ä½•è°ƒè¯•å•ä¸ªæµ‹è¯•?

A: ä½¿ç”¨ pdb è°ƒè¯•å™¨:
```bash
pytest tests/scenarios/test_xxx.py::test_func --pdb
```

### Q: æµ‹è¯•å¤ªæ…¢æ€ä¹ˆåŠ?

A: ä½¿ç”¨ pytest-xdist å¹¶è¡Œè¿è¡Œ:
```bash
pytest tests/scenarios/ -n auto
```

### Q: å¦‚ä½•åªè¿è¡Œå¤±è´¥çš„æµ‹è¯•?

A: ä½¿ç”¨ --lf (last failed) é€‰é¡¹:
```bash
pytest tests/scenarios/ --lf
```

### Q: æµ‹è¯•æ•°æ®åº“åœ¨å“ªé‡Œ?

A: æµ‹è¯•ä½¿ç”¨ SQLite å†…å­˜æ•°æ®åº“,ä¸ä¼šå½±å“ç”Ÿäº§æ•°æ®åº“ã€‚æµ‹è¯•ç»“æŸåæ•°æ®åº“ä¼šè¢«åˆ é™¤ã€‚

## ğŸ“§ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜,è¯·è”ç³»å¼€å‘å›¢é˜Ÿæˆ–æäº¤ Issueã€‚
